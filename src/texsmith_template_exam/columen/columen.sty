%%
%% This is file `columen.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% columen.dtx  (with options: `package')
%% This is a generated file.
\NeedsTeXFormat{LaTeX2e}[2020-10-01]
\ProvidesPackage{columen}[2024/06/13 v0.1 Automatically balance list columns]
\RequirePackage{xparse}
\RequirePackage{multicol}
\RequirePackage{etoolbox}

\newcommand\columen@pendingpreset{}
\DeclareOption{defaults=exam}{\gdef\columen@pendingpreset{exam}}
\DeclareOption*{%
  \PackageWarning{columen}{Unknown option '\CurrentOption'}%
}
\ProcessOptions\relax

\@namedef{columen@preset@exam}{itemize,enumerate,description,choices,checkboxes,oneparchoices,oneparcheckboxes,parts,subparts}

\makeatletter

\newif\ifWI@pending
\newif\ifWI@broke
\newif\ifWI@rerun
\newif\ifWI@usemulticols
\newif\ifWI@locked
\newif\ifWI@star
\WI@rerunfalse

\newcount\WI@columncount
\newcount\WI@nextcolumns
\newcount\WI@maxcolumns
\newcount\WI@listcounter
\WI@listcounter=0\relax

\newcommand\WI@defaultmaxcols{5}

\newif\ifWI@columen
\newif\ifWI@columenstar
\newif\ifWI@columenhaskey
\newcount\WI@columendepth
\newcount\WI@columenlistcount
\WI@columenfalse
\WI@columenstarfalse
\WI@columenhaskeyfalse
\WI@columendepth=0\relax
\WI@columenlistcount=0\relax
\newcommand\WI@columencols{\WI@defaultmaxcols}
\newcommand\WI@columenkey{}

\newif\ifWI@usetcbitemize
\newif\ifWI@hadtcbcolumns
\newif\ifWI@tcbitemfirst
\WI@usetcbitemizefalse
\WI@hadtcbcolumnsfalse
\WI@tcbitemfirsttrue
\let\WI@oldtcbcolumns\relax
\newbox\WI@tcb@box
\newdimen\WI@tcb@baseline
\newdimen\WI@tcb@height
\newdimen\WI@tcb@diff

\newcommand\WI@getcols[1]{%
  \@ifundefined{WI@cols@#1}{\the\WI@maxcolumns}{\csname WI@cols@#1\endcsname}%
}

\newcommand\WI@definecols[2]{%
  \expandafter\gdef\csname WI@cols@#1\endcsname{#2}%
}

\newcommand\WI@writecols[2]{%
  \begingroup
    \edef\WI@tempa{\string\WI@definecols{#1}{#2}}%
    \protected@write\@auxout{}{\WI@tempa}%
  \endgroup
}

\newcommand\WI@getlock[1]{%
  \@ifundefined{WI@lock@#1}{0}{\csname WI@lock@#1\endcsname}%
}

\newcommand\WI@definelock[2]{%
  \expandafter\gdef\csname WI@lock@#1\endcsname{#2}%
}

\newcommand\WI@writelock[2]{%
  \begingroup
    \edef\WI@tempb{\string\WI@definelock{#1}{#2}}%
    \protected@write\@auxout{}{\WI@tempb}%
  \endgroup
}

\newcommand\WI@generatekey{%
  \global\advance\WI@listcounter\@ne
  \edef\WI@currentkey{auto-\the\WI@listcounter}%
}

\newif\ifWI@active
\WI@activefalse

\newcount\WI@save@beginparpenalty
\newcount\WI@save@itempenalty
\newcount\WI@save@endparpenalty
\newif\ifWI@restorepenalties
\WI@restorepenaltiesfalse

\newcommand\WI@maybeRelaxSamepagePenalties{%
  \WI@restorepenaltiesfalse
  \ifnum\@beginparpenalty=\@M
    \ifnum\@itempenalty=\@M
      \ifnum\@endparpenalty=\@M
        \WI@save@beginparpenalty=\@beginparpenalty
        \WI@save@itempenalty=\@itempenalty
        \WI@save@endparpenalty=\@endparpenalty
        \@beginparpenalty=0\relax
        \@itempenalty=0\relax
        \@endparpenalty=0\relax
        \WI@restorepenaltiestrue
      \fi
    \fi
  \fi
}

\newcommand\WI@restoreSamepagePenalties{%
  \ifWI@restorepenalties
    \@beginparpenalty=\WI@save@beginparpenalty
    \@itempenalty=\WI@save@itempenalty
    \@endparpenalty=\WI@save@endparpenalty
    \WI@restorepenaltiesfalse
  \fi
}

\newcommand\WI@maybeWarn@[1]{%
  \ifnum#1>1
    \global\WI@broketrue
    \PackageWarning{columen}{A list item broke across #1 lines}%
  \else
    \ifnum\badness>\@M\relax
      \global\WI@broketrue
      \PackageWarning{columen}{A list item overfull in a column; reducing columns}%
    \fi
  \fi
  \WI@pendingfalse
}

\newcommand\WI@floatwarn[1]{%
  \ifWI@active
    \PackageWarning{columen}{Floating environments inside columen items are unsupported; move the float outside}%
  \fi
}
\pretocmd{\@float}{\WI@floatwarn{#1}}{}{}
\pretocmd{\@dblfloat}{\WI@floatwarn{#1}}{}{}

\newcommand\WI@checkpending{%
  \ifWI@active
    \ifWI@pending
      \expandafter\WI@maybeWarn@\expandafter{\the\prevgraf}%
    \fi
  \fi
}

\newcommand\WI@armpending{%
  \ifWI@active
    \WI@pendingtrue
  \fi
}

\AddToHook{para/after}{\WI@checkpending}
\AddToHook{cmd/item/before}{\WI@armpending}

\AtEndDocument{%
  \ifWI@rerun
    \PackageWarningNoLine{columen}{List columns expanded; rerun LaTeX}%
  \fi
}

\newcommand\WI@startcolumns[1]{%
    \global\WI@activetrue
    \global\WI@brokefalse
    \WI@pendingfalse
    \WI@hadtcbcolumnsfalse
    \WI@maxcolumns=#1\relax
    \ifnum\WI@maxcolumns<1 \WI@maxcolumns=1\fi
    \WI@lockedfalse
    \WI@usemulticolstrue
    \ifWI@star
      \WI@columncount=\WI@maxcolumns
    \else
      \WI@columncount=\WI@getcols{\WI@currentkey}\relax
      \ifnum\WI@columncount<1 \WI@columncount=1\fi
      \ifnum\WI@columncount>\WI@maxcolumns
        \WI@columncount=\WI@maxcolumns
      \fi
      \ifnum\WI@getlock{\WI@currentkey}>0\relax
        \WI@lockedtrue
      \fi
    \fi
    \ifWI@usetcbitemize
      \WI@usemulticolsfalse
      \WI@hadtcbcolumnstrue
      \let\WI@oldtcbcolumns\kvtcb@raster@columns
      \edef\kvtcb@raster@columns{\the\WI@columncount}%
    \else
      \ifnum\WI@columncount=1
        \WI@usemulticolsfalse
      \fi
    \fi
    \ifnum\WI@columncount=1
      \WI@usemulticolsfalse
    \fi
    \ifWI@usemulticols
      \WI@maybeRelaxSamepagePenalties
      \ifWI@star
        \begin{multicols*}{\the\WI@columncount}%
      \else
        \begin{multicols}{\the\WI@columncount}%
      \fi
    \fi
}

\newcommand\WI@endcolumns{%
    \WI@checkpending
    \ifWI@usemulticols
      \ifWI@star
        \end{multicols*}%
      \else
        \end{multicols}%
      \fi
      \WI@restoreSamepagePenalties
    \fi
    \ifWI@star
      % starred variant is manual; keep requested column count
    \else
      \WI@nextcolumns=\WI@columncount
      \ifWI@broke
        \ifnum\WI@columncount>1
          \advance\WI@nextcolumns\m@ne
          \WI@lockedtrue
        \fi
      \else
        \ifWI@locked
          % keep current column count
        \else
          \ifnum\WI@nextcolumns<\WI@maxcolumns
            \advance\WI@nextcolumns\@ne
            \global\WI@reruntrue
          \fi
        \fi
      \fi
      \ifnum\WI@nextcolumns<1 \WI@nextcolumns=1\fi
      \WI@writecols{\WI@currentkey}{\the\WI@nextcolumns}%
      \ifWI@locked
        \WI@writelock{\WI@currentkey}{1}%
      \else
        \WI@writelock{\WI@currentkey}{0}%
      \fi
    \fi
    \ifWI@usetcbitemize
      \ifWI@hadtcbcolumns
        \let\kvtcb@raster@columns\WI@oldtcbcolumns
        \WI@hadtcbcolumnsfalse
      \fi
    \fi
    \WI@starfalse
    \global\WI@activefalse
}

\newcommand\WI@columen@begin[2]{%
  \ifWI@columen
    \PackageError{columen}{Nested columen environments are unsupported}{%
      Close the surrounding columen environment before starting another.%
    }%
  \fi
  \WI@columentrue
  \WI@columendepth=0\relax
  \WI@columenlistcount=0\relax
  \def\WI@columencols{#1}%
  \IfNoValueTF{#2}{%
    \WI@columenhaskeyfalse
  }{%
    \WI@columenhaskeytrue
    \def\WI@columenkey{#2}%
  }%
}

\newcommand\WI@columen@end{%
  \ifWI@columen
    \ifnum\WI@columendepth>0\relax
      \WI@endcolumns
    \fi
    \WI@columenfalse
    \WI@columenstarfalse
    \WI@columenhaskeyfalse
    \WI@columendepth=0\relax
    \WI@columenlistcount=0\relax
  \fi
}

\newcommand\WI@columen@before{%
  \ifWI@columen
    \advance\WI@columendepth\@ne
    \ifnum\WI@columendepth=\@ne
      \advance\WI@columenlistcount\@ne
      \ifWI@columenhaskey
        \protected@edef\WI@currentkey{\WI@columenkey-\the\WI@columenlistcount}%
      \else
        \WI@generatekey
      \fi
      \ifWI@columenstar
        \WI@startrue
      \else
        \WI@starfalse
      \fi
      \WI@startcolumns{\WI@columencols}%
    \fi
  \fi
}

\newcommand\WI@columen@after{%
  \ifWI@columen
    \ifnum\WI@columendepth>0\relax
      \ifnum\WI@columendepth=\@ne
        \WI@endcolumns
      \fi
      \advance\WI@columendepth\m@ne
    \fi
  \fi
}

\newcommand\WI@columen@patch[1]{%
  \BeforeBeginEnvironment{#1}{\WI@columen@before}%
  \AfterEndEnvironment{#1}{\WI@columen@after}%
}

\newcommand\WI@columen@maybe[1]{%
  \@ifundefined{#1}{}{%
    \WI@columen@patch{#1}%
  }%
}

\NewDocumentCommand{\ColumenPatch}{m}{%
  \WI@columen@patch{#1}%
}

\NewDocumentCommand{\columenfor}{m}{%
  \forcsvlist{\WI@columen@maybe}{#1}%
}

\newcommand\columen@applypreset[1]{%
  \edef\columen@optiondefaults{#1}%
  \@ifundefined{columen@preset@\columen@optiondefaults}{%
    \PackageWarning{columen}{Unknown defaults preset '#1'; ignoring}%
  }{%
    \columenfor{\csname columen@preset@\columen@optiondefaults\endcsname}%
  }%
}

\AtBeginDocument{%
  \ifx\columen@pendingpreset\@empty
  \else
    \columen@applypreset{\columen@pendingpreset}%
  \fi
}

\NewDocumentEnvironment{columen}{O{\WI@defaultmaxcols} o}
  {%
    \WI@columenstarfalse
    \WI@columen@begin{#1}{#2}%
  }
  {\WI@columen@end}

\NewDocumentEnvironment{columen*}{O{\WI@defaultmaxcols} o}
  {%
    \WI@columenstartrue
    \WI@columen@begin{#1}{#2}%
  }
  {\WI@columen@end}

\WI@columen@maybe{itemize}
\WI@columen@maybe{enumerate}
\WI@columen@maybe{choices}
\WI@columen@maybe{checkboxes}
\WI@columen@maybe{description}

\newcommand\WI@tcbitem@prepare{%
  \ifWI@usetcbitemize
    \WI@pendingtrue
    \global\WI@tcbitemfirstfalse
  \fi
}

\newcommand\WI@tcbitem@finalize{%
  \ifWI@usetcbitemize
    \ifWI@tcbitemfirst
      % nothing yet
    \else
      \ifvmode
        \setbox\WI@tcb@box=\lastbox
        \ifvoid\WI@tcb@box
          % nothing to measure
        \else
          \WI@tcb@height=\ht\WI@tcb@box
          \advance\WI@tcb@height\dp\WI@tcb@box
          \ifdim\WI@tcb@baseline=0pt
            \WI@tcb@baseline=\WI@tcb@height
          \else
            \ifdim\WI@tcb@height<\WI@tcb@baseline
              \WI@tcb@baseline=\WI@tcb@height
            \fi
          \fi
          \WI@tcb@diff=\WI@tcb@height
          \advance\WI@tcb@diff-\WI@tcb@baseline
          \ifdim\WI@tcb@diff>\baselineskip
            \WI@maybeWarn@{2}%
          \else
            \WI@maybeWarn@{1}%
          \fi
          \box\WI@tcb@box
        \fi
      \fi
    \fi
  \fi
}

\newcommand\columen@setuptcb{%
  \BeforeBeginEnvironment{tcbitemize}{%
    \ifWI@columen
      \WI@usetcbitemizetrue
      \WI@columen@before
      \WI@tcbitemfirsttrue
      \WI@tcb@baseline=0pt
    \else
      \WI@usetcbitemizefalse
    \fi
  }%
  \AfterEndEnvironment{tcbitemize}{%
    \ifWI@usetcbitemize
      \WI@tcbitem@finalize
      \WI@columen@after
      \WI@usetcbitemizefalse
    \fi
  }%
  \renewcommand{\tcbitem@first}[1][]{%
    \WI@tcbitem@prepare
    \let\tcbitem=\tcbitem@following
    \begin{tcolorbox}[{##1}]%
  }%
  \renewcommand{\tcbitem@following}[1][]{%
    \end{tcolorbox}%
    \WI@tcbitem@finalize
    \WI@tcbitem@prepare
    \begin{tcolorbox}[{##1}]%
  }%
}

\@ifundefined{tcbitemize}{%
  \AtBeginDocument{\@ifpackageloaded{tcolorbox}{\columen@setuptcb}{}}%
}{%
  \columen@setuptcb
}

\makeatother
\endinput
%%
%% End of file `columen.sty'.
