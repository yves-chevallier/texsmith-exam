\BLOCK{ set exam_type_raw = type|default('exam')|string }
\BLOCK{ set exam_type = exam_type_raw|lower }
\BLOCK{ set title_value = title|default('')|trim }
\BLOCK{ set author_value = author|default('')|trim }
\BLOCK{ set date_value = date|default('')|trim }
\BLOCK{ set titlepage_raw = titlepage|default('cover')|string|lower }
\BLOCK{ set titlepage_minimal = titlepage_raw == 'minimal' }
\BLOCK{ set lang = language|default('english')|lower }
\BLOCK{ if lang in ['french', 'fr', 'francais'] }
  \BLOCK{ set label_problem = "Probl\\`eme" }
  \BLOCK{ set label_rules = "Consignes" }
  \BLOCK{ set label_next_page = "Allez \\`a la page suivante..." }
  \BLOCK{ set label_page_of = "Page \\thepage\\ sur \\pageref{LastPage}" }
  \BLOCK{ set label_end_exam = "Fin de l'examen" }
  \BLOCK{ set label_name = "Nom, Pr\\'enom" }
  \BLOCK{ set label_duration = "Dur\\'ee" }
\BLOCK{ elif lang in ['italian', 'it', 'italiano'] }
  \BLOCK{ set label_problem = "Problema" }
  \BLOCK{ set label_rules = "Istruzioni" }
  \BLOCK{ set label_next_page = "Vai alla pagina successiva..." }
  \BLOCK{ set label_page_of = "Pagina \\thepage\\ di \\pageref{LastPage}" }
  \BLOCK{ set label_end_exam = "Fine dell'esame" }
  \BLOCK{ set label_name = "Cognome, Nome" }
  \BLOCK{ set label_duration = "Durata" }
\BLOCK{ elif lang in ['german', 'de', 'deutsch'] }
  \BLOCK{ set label_problem = "Aufgabe" }
  \BLOCK{ set label_rules = "Hinweise" }
  \BLOCK{ set label_next_page = "Bitte zur n\\\"achsten Seite..." }
  \BLOCK{ set label_page_of = "Seite \\thepage\\ von \\pageref{LastPage}" }
  \BLOCK{ set label_end_exam = "Ende der Pr\\\"ufung" }
  \BLOCK{ set label_name = "Nachname, Vorname" }
  \BLOCK{ set label_duration = "Dauer" }
\BLOCK{ else }
  \BLOCK{ set label_problem = "Problem" }
  \BLOCK{ set label_rules = "Instructions" }
  \BLOCK{ set label_next_page = "Go to the next page..." }
  \BLOCK{ set label_page_of = "Page \\thepage\\ of \\pageref{LastPage}" }
  \BLOCK{ set label_end_exam = "End of the exam" }
  \BLOCK{ set label_name = "Surname, First name" }
  \BLOCK{ set label_duration = "Duration" }
\BLOCK{ endif }
\BLOCK{ set base_docclass_options = documentclass_options|default('', true) }
\BLOCK{ set combined_docclass_options = base_docclass_options[1:-1] if base_docclass_options else '' }
\BLOCK{ set option_parts = [] }
\BLOCK{ if combined_docclass_options }\BLOCK{ set option_parts = option_parts + [combined_docclass_options] }\BLOCK{ endif }
\BLOCK{ set option_parts = option_parts + ['addpoints'] }
\BLOCK{ set effective_documentclass_options = '[' ~ option_parts|join(',') ~ ']' if option_parts else '' }
\documentclass\VAR{effective_documentclass_options}{exam}
\pointsinrightmargin
\BLOCK{ if solution }
\printanswers
\BLOCK{ endif }

\usepackage[svgnames,dvipsnames,x11names]{xcolor}
\VAR{extra_packages}
\usepackage[defaults=exam]{columen}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{ifthen}
\usepackage{eso-pic}
\usepackage[\VAR{language|default('english')}]{babel}
\usepackage{lastpage}
\BLOCK{ if not ts_typesetting_enabled|default(false) }
\setlength{\parskip}{1.2em}
\setlength{\parindent}{0pt}
\BLOCK{ endif }
\usepackage{heiglogo}

\newif\ifexamquestionsopen
\examquestionsopenfalse
\newcommand{\ExamQuestionsBegin}{%
  \ifexamquestionsopen\else
    \begin{questions}%
    \examquestionsopentrue
  \fi
}
\newcommand{\ExamQuestionsEnd}{%
  \ifexamquestionsopen
    \end{questions}%
    \examquestionsopenfalse
  \fi
}

\makeatletter
\unframedsolutions
\renewcommand{\solutiontitle}{}
\renewenvironment{TheSolution}%
  {%
    \vspace{\parskip}%
    \leftskip=0pt
    \rightskip=0pt
    \begingroup
    \color{red}%
    \tcbset{colframe=red,coltitle=red}%
    \tcbset{code/.append style={colframe=red,coltitle=red}}%
    \def\PY##1##2{##2}%
    \ignorespaces
  }%
  {%
    \unskip
    \endgroup
  }%
\CorrectChoiceEmphasis{\bfseries\color{red}}
\@ifpackageloaded{tcolorbox}{}{%
  \PassOptionsToPackage{most,skins,breakable}{tcolorbox}%
  \usepackage{tcolorbox}%
}
\renewenvironment{solutionorgrid}[1][0pt]%
  {%
    \@insolutiontrue
    \@addpointsfalse
    \@ifundefined{ifsolutionsreseteqcounter}{}{%
      \ifsolutionsreseteqcounter
        \setcounter{exam@saved@eqnum}{\value{equation}}%
        \setcounter{equation}{0}%
      \fi
    }%
    \ifprintanswers
      \begingroup
      \Solution@Emphasis
      \begin{TheSolution}%
    \else
      \ifcancelspace
        % Do nothing
      \else
        \par
        \penalty 0
        \vspace{1em}%
        \fillwithgrid{#1}%
        \vspace{1em}%
      \fi
      \setbox\z@\vbox\bgroup
    \fi
  }{%
    \ifprintanswers
      \end{TheSolution}%
      \endgroup
    \else
      \egroup
    \fi
    \@ifundefined{ifsolutionsreseteqcounter}{}{%
      \ifsolutionsreseteqcounter
        \setcounter{equation}{\value{exam@saved@eqnum}}%
      \fi
    }%
  }%
\makeatother

% Grid styling for solution boxes
\colorgrids
\definecolor{GridColor}{gray}{0.7}
\setlength{\gridsize}{5mm}

\qformat{\vbox{\hbox to \hsize{\textbf{\VAR{label_problem} \thequestion : \thequestiontitle}\hfill(\thepoints)}\vspace{0.8em}}}
\renewcommand{\partlabel}{\textbf{(\thepartno)}}
\renewcommand{\subpartlabel}{\textbf{\thesubpart.}}
\renewcommand{\subsubpartlabel}{\textbf{\thesubsubpart)}}
\renewcommand{\questionshook}{%
  % Only reduce spacing after question labels, keep parts/subparts defaults.
  \setlength{\labelsep}{0.4em}%
  \settowidth{\leftmargin}{2.\hskip\labelsep}%
  \labelwidth\leftmargin\advance\labelwidth-\labelsep
  \setlength{\itemindent}{0pt}%
  \setlength{\itemsep}{1em plus 0.5em minus 0.5em}%
  \setlength{\parsep}{0.4em}%
}
\renewcommand{\partshook}{%
  \setlength{\parsep}{0.4em}%
}
\renewcommand{\subpartshook}{%
  \setlength{\parsep}{0.4em}%
}
\renewcommand{\choiceshook}{%
  % Reduce the extra 2.5em indent that exam.cls adds for choices.
  \settowidth{\leftmargin}{W.\hskip\labelsep\hskip 1em}%
  \labelwidth\leftmargin\advance\labelwidth-\labelsep
  \setlength{\topsep}{0.4em}%
  \setlength{\partopsep}{0pt}%
  \setlength{\itemsep}{0.2em}%
  \setlength{\parsep}{0pt}%
}
\renewcommand{\checkboxeshook}{%
  \settowidth{\leftmargin}{W.\hskip\labelsep\hskip 1em}%
  \labelwidth\leftmargin\advance\labelwidth-\labelsep
  \setlength{\topsep}{0.4em}%
  \setlength{\partopsep}{0pt}%
  \setlength{\itemsep}{0.2em}%
  \setlength{\parsep}{0pt}%
}

\newtcolorbox{examrules}[1][]{%
  enhanced jigsaw,
  sharp corners,
  colback=white,
  borderline={1pt}{-2pt}{black},
  #1
}

\BLOCK{ set document_type = exam_type_raw|lower }
\BLOCK{ if document_type in ["te", "travail ecrit", "travail Ã©crit"] }
\BLOCK{ set document_type_label = "Travail \\'Ecrit" }
\BLOCK{ else }
\BLOCK{ set document_type_label = exam_type_raw|default("Exam") }
\BLOCK{ endif }
\BLOCK{ set display_title = title_value if title_value else (document_type_label ~ " " ~ course) }
\BLOCK{ set author_payload = author|default('') }
\BLOCK{ set author_ns = namespace(lines=[]) }
\BLOCK{ if author_payload is string }
  \BLOCK{ set author_text = author_payload|trim }
  \BLOCK{ if author_text }
    \BLOCK{ set author_ns.lines = [author_text|latex_escape] }
  \BLOCK{ endif }
\BLOCK{ elif author_payload is mapping }
  \BLOCK{ set author_name = author_payload.get('name')|default('')|trim }
  \BLOCK{ set author_aff = author_payload.get('affiliation')|default('')|string|trim }
  \BLOCK{ set author_aff_lower = author_aff|lower }
  \BLOCK{ if author_aff_lower in ['none', 'null'] }
    \BLOCK{ set author_aff = '' }
  \BLOCK{ endif }
  \BLOCK{ if author_name }
    \BLOCK{ set author_ns.lines = [author_name|latex_escape] }
    \BLOCK{ if author_aff }
      \BLOCK{ set author_ns.lines = author_ns.lines + [author_aff|latex_escape] }
    \BLOCK{ endif }
  \BLOCK{ endif }
\BLOCK{ elif author_payload is sequence }
  \BLOCK{ for entry in author_payload }
    \BLOCK{ if entry is string }
      \BLOCK{ set entry_name = entry|trim }
      \BLOCK{ set entry_aff = '' }
    \BLOCK{ elif entry is mapping }
      \BLOCK{ set entry_name = entry.get('name')|default('')|trim }
      \BLOCK{ set entry_aff = entry.get('affiliation')|default('')|string|trim }
      \BLOCK{ set entry_aff_lower = entry_aff|lower }
      \BLOCK{ if entry_aff_lower in ['none', 'null'] }
        \BLOCK{ set entry_aff = '' }
      \BLOCK{ endif }
    \BLOCK{ else }
      \BLOCK{ set entry_name = '' }
      \BLOCK{ set entry_aff = '' }
    \BLOCK{ endif }
    \BLOCK{ if entry_name }
      \BLOCK{ set author_ns.lines = author_ns.lines + [entry_name|latex_escape] }
      \BLOCK{ if entry_aff }
        \BLOCK{ set author_ns.lines = author_ns.lines + [entry_aff|latex_escape] }
      \BLOCK{ endif }
      \BLOCK{ if not loop.last }
        \BLOCK{ set author_ns.lines = author_ns.lines + [''] }
      \BLOCK{ endif }
    \BLOCK{ endif }
  \BLOCK{ endfor }
\BLOCK{ endif }
\BLOCK{ set author_rendered = author_ns.lines|join('\\\\') }
\BLOCK{ set author_trim = author_rendered|trim }
\BLOCK{ set date_trim = date_value|default('')|trim }
\BLOCK{ set course_trim = course|default('')|trim }

\title{\VAR{display_title}}
\author{\VAR{author_rendered}}

\def\thedate{\VAR{date_value if date_value else "\\today"}}
\def\department{\VAR{department}}
\def\school{\VAR{school}}
\def\subtitle{\VAR{subtitle}}
\def\documentType{\VAR{document_type_label}}
\def\course{\VAR{course}}
\def\duration{\VAR{duration|default('')}}

\makeatletter
\BLOCK{ if titlepage_minimal }
\def\@maketitle{%
  \logo[top=10mm,height=1.26cm]
  \begingroup
  \centering
  {\LARGE \@title \par}%
  \ifprintanswers
    \vskip .1em%
    \large \textbf{\textcolor{red}{Solution}}%
  \fi
  \vskip .15em%
  {\itshape\subtitle\par}%
  \vskip .5em%
  \BLOCK{ if author_trim }
  {%
    \lineskip .2em%
    \begin{tabular}[t]{c}%
      \@author
    \end{tabular}\par
  }%
  \vskip 0.4em%
  \BLOCK{ endif }
  \BLOCK{ if course_trim }
  {\large \course\par}%
  \vskip 0.2em%
  \BLOCK{ endif }
  \BLOCK{ if date_trim }
  {\large \thedate\par}%
  \BLOCK{ endif }
  \BLOCK{ set school_trim = school|default('')|trim }
  \BLOCK{ set department_trim = department|default('')|trim }
  \BLOCK{ if school_trim or department_trim }
  \vskip 0.3em%
  {\itshape\school~--~\department\par}%
  \BLOCK{ endif }
  \endgroup
  \vskip 0.6em%
  \hrule
  \vskip 1em%
}
\BLOCK{ else }
\def\@maketitle{%
  \newpage
  \logo[top=10mm,height=1.26cm]
  \AddToShipoutPictureFG*{%
    \AtPageUpperLeft{%
      \put(1cm,-2.5cm){%
        \begin{minipage}[t]{\dimexpr\paperwidth-2cm\relax}
          \hfill
          \begin{minipage}[t]{5.5cm}\raggedleft\bfseries \VAR{label_name}~:\end{minipage}%
          \hspace{0.5em}%
          \begin{minipage}[t]{8cm}\fbox{\makebox[\linewidth][l]{\rule{0pt}{0.8cm}}}\end{minipage}%
        \end{minipage}%
      }%
    }%
  }
  \null
  \vskip 8em%
  \begin{center}%
    {\LARGE \@title \par}%
    \ifprintanswers
      \large \textbf{\textcolor{red}{Solution}}%
    \fi
    \vskip .2em%
    {\itshape\subtitle\par}%
    \vskip .6em%
    {\itshape\school~--~\department\par}%
    \vskip 2.5em%
    \BLOCK{ if author_trim }
    {%
      \lineskip .2em%
      \begin{minipage}{0.8 \textwidth}%
        \begin{center}%
          \begin{tabular}[t]{c}%
            \@author
          \end{tabular}\par
        \end{center}%
      \end{minipage}%
    }%
    \vskip 1em%
    \BLOCK{ endif }
    \BLOCK{ if course_trim }
    {\large \course\par}%
    \vskip 0.4em%
    \BLOCK{ endif }
    \BLOCK{ if date_trim }
    {\large \thedate}%
    \BLOCK{ endif }
  \end{center}%
  \par
  \vskip 1.5em%
}
\BLOCK{ endif }

\firstpageheader{\school~/~\ifprintanswers \textcolor{red}{Solution} \fi \VAR{title_value}}{}{\VAR{label_problem} \thequestion}
\runningheader{\school~/~\ifprintanswers \textcolor{red}{Solution} \fi \VAR{title_value}}{}{\VAR{label_problem} \thequestion}
\footer{\ifthenelse{\value{page}=\pageref{LastPage}}{\VAR{label_end_exam}}{\VAR{label_next_page}}}{\VAR{label_page_of}}{\course}
\pagestyle{headandfoot}
\makeatother

\begin{document}
\BLOCK{ if titlepage_minimal }
  \maketitle
\BLOCK{ else }
\begin{coverpages}
  \maketitle
  \thispagestyle{empty}

  \begin{center}
    \noindent \VAR{label_duration} : \duration~minutes
    \vfil
  \end{center}

  \begin{center}
    \gradetable[v][questions]
  \end{center}
  \vfil

  \BLOCK{ if rules }
  \begin{center}
    \begin{examrules}
      \textbf{\VAR{label_rules} : }
      \vskip 1em%
      \begin{itemize}
      \BLOCK{ for rule in rules }
        \item \VAR{rule|markdown_to_latex}
      \BLOCK{ endfor }
      \end{itemize}
    \end{examrules}
  \end{center}
  \BLOCK{ endif }
\end{coverpages}
\BLOCK{ endif }

\BLOCK{ set has_questions = ("\\question" in mainmatter) or ("\\titledquestion" in mainmatter) or ("\\input" in mainmatter) }
\BLOCK{ if has_questions }
\VAR{mainmatter}
\ExamQuestionsEnd
\BLOCK{ else }
\PackageWarning{texsmith}{No questions found; exam.cls may fail to compile.}
\VAR{mainmatter}
\BLOCK{ endif }

\VAR{fragment_backmatter}
\end{document}
