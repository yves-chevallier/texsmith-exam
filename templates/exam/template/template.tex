\BLOCK{ set exam_type_raw = type|default('exam')|string }
\BLOCK{ set exam_type = exam_type_raw|lower }
\BLOCK{ set title_value = title|default('')|trim }
\BLOCK{ set author_value = author|default('')|trim }
\BLOCK{ set date_value = date|default('')|trim }
\documentclass[a4paper,twoside,addpoints]{exam}
\pointsinrightmargin
\BLOCK{ if solution }
\printanswers
\BLOCK{ endif }

\usepackage[a4paper,margin=2.5cm,includeheadfoot]{geometry}
\usepackage[svgnames,dvipsnames,x11names]{xcolor}
\VAR{extra_packages}
\usepackage[defaults=exam]{columen}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{ifthen}
\usepackage[\VAR{language|default('french')}]{babel}
\usepackage[colorlinks=true, linkcolor=NavyBlue, urlcolor=NavyBlue, citecolor=NavyBlue]{hyperref}
\usepackage[normalem]{ulem}
\usepackage{lastpage}
\usepackage{parskip}
\usepackage{heiglogo}

\makeatletter
\unframedsolutions
\renewcommand{\solutiontitle}{}
\renewenvironment{TheSolution}%
  {%
    \vspace{\parskip}%
    \leftskip=0pt
    \rightskip=0pt
    \begingroup
    \color{red}%
    \tcbset{colframe=red,coltitle=red}%
    \tcbset{code/.append style={colframe=red,coltitle=red}}%
    \def\PY##1##2{##2}%
    \ignorespaces
  }%
  {%
    \unskip
    \endgroup
  }%
\CorrectChoiceEmphasis{\bfseries\color{red}}
\@ifpackageloaded{tcolorbox}{}{%
  \PassOptionsToPackage{most,skins,breakable}{tcolorbox}%
  \usepackage{tcolorbox}%
}
\renewenvironment{solutionorgrid}[1][0pt]%
  {%
    \@insolutiontrue
    \@addpointsfalse
    \@ifundefined{ifsolutionsreseteqcounter}{}{%
      \ifsolutionsreseteqcounter
        \setcounter{exam@saved@eqnum}{\value{equation}}%
        \setcounter{equation}{0}%
      \fi
    }%
    \ifprintanswers
      \begingroup
      \Solution@Emphasis
      \begin{TheSolution}%
    \else
      \ifcancelspace
        % Do nothing
      \else
        \par
        \penalty 0
        \vspace{1em}%
        \fillwithgrid{#1}%
        \vspace{1em}%
      \fi
      \setbox\z@\vbox\bgroup
    \fi
  }{%
    \ifprintanswers
      \end{TheSolution}%
      \endgroup
    \else
      \egroup
    \fi
    \@ifundefined{ifsolutionsreseteqcounter}{}{%
      \ifsolutionsreseteqcounter
        \setcounter{equation}{\value{exam@saved@eqnum}}%
      \fi
    }%
  }%
\makeatother

% Grid styling for solution boxes
\colorgrids
\definecolor{GridColor}{gray}{0.7}
\setlength{\gridsize}{5mm}

\qformat{\vbox{\hbox to \hsize{\textbf{Probl\`eme \thequestion : \thequestiontitle}\hfill(\thepoints)}\vspace{0.8em}}}
\renewcommand{\questionshook}{%
  % Only reduce spacing after question labels, keep parts/subparts defaults.
  \setlength{\labelsep}{0.4em}%
  \settowidth{\leftmargin}{2.\hskip\labelsep}%
  \labelwidth\leftmargin\advance\labelwidth-\labelsep
  \setlength{\itemindent}{0pt}%
}
\renewcommand{\choiceshook}{%
  % Reduce the extra 2.5em indent that exam.cls adds for choices.
  \settowidth{\leftmargin}{W.\hskip\labelsep\hskip 1em}%
  \labelwidth\leftmargin\advance\labelwidth-\labelsep
  \setlength{\topsep}{0.8em}%
  \setlength{\partopsep}{0pt}%
  \setlength{\itemsep}{0.2em}%
  \setlength{\parsep}{0pt}%
}
\renewcommand{\checkboxeshook}{%
  \settowidth{\leftmargin}{W.\hskip\labelsep\hskip 1em}%
  \labelwidth\leftmargin\advance\labelwidth-\labelsep
  \setlength{\topsep}{0.8em}%
  \setlength{\partopsep}{0pt}%
  \setlength{\itemsep}{0.2em}%
  \setlength{\parsep}{0pt}%
}

\newtcolorbox{examrules}[1][]{%
  enhanced jigsaw,
  sharp corners,
  colback=white,
  borderline={1pt}{-2pt}{black},
  #1
}

\BLOCK{ set document_type = exam_type_raw|lower }
\BLOCK{ if document_type in ["te", "travail ecrit", "travail écrit"] }
\BLOCK{ set document_type_label = "Travail \\\\'Ecrit" }
\BLOCK{ else }
\BLOCK{ set document_type_label = exam_type_raw|default("Exam") }
\BLOCK{ endif }
\BLOCK{ set display_title = title_value if title_value else (document_type_label ~ " " ~ course) }

\title{\VAR{display_title}}
\author{\VAR{author}}

\def\thedate{\VAR{date_value if date_value else "\\\\today"}}
\def\department{\VAR{department}}
\def\school{\VAR{school}}
\def\subtitle{\VAR{subtitle}}
\def\documentType{\VAR{document_type_label}}
\def\course{\VAR{course}}
\def\duration{\VAR{duration|default('')}}

\makeatletter
\def\@maketitle{%
  \newpage
  \heiglogo[color=black]
  \null
  \vskip 8em%
  \begin{center}%
    {\LARGE \@title \par}%
    \ifprintanswers
      \large \textbf{\textcolor{red}{Solution}}%
    \fi
    \vskip .2em%
    {\itshape\subtitle\par}%
    \vskip .6em%
    {\itshape\school~--~\department\par}%
    \vskip 2.5em%
    {%
      \lineskip .2em%
      \begin{minipage}{0.8 \textwidth}%
        \begin{center}%
          \begin{tabular}[t]{c}%
            \@author
          \end{tabular}\par
        \end{center}%
      \end{minipage}%
    }%
    \vskip 1em%
    {\large \thedate}%
  \end{center}%
  \par
  \vskip 1.5em%
}

\firstpageheader{\school~/~\ifprintanswers \textcolor{red}{Solution} \fi \VAR{title_value}}{}{Probl\`eme \thequestion}
\runningheader{\school~/~\ifprintanswers \textcolor{red}{Solution} \fi \VAR{title_value}}{}{Probl\`eme \thequestion}
\footer{\ifthenelse{\value{page}=\pageref{LastPage}}{fin de l'examen}{Allez \`a la page suivante...}}{Page \thepage\ sur \pageref{LastPage}}{\course}
\pagestyle{headandfoot}
\makeatother

\begin{document}
\begin{coverpages}
  \maketitle
  \thispagestyle{empty}

  \begin{center}
    \noindent Durée : \duration~minutes
    \vfil
  \end{center}

  \begin{center}
    \gradetable[v][questions]
  \end{center}
  \vfil

  \BLOCK{ if rules }
  \begin{center}
    \begin{examrules}
      \textbf{Consignes : }
      \vskip 1em%
      \begin{itemize}
      \BLOCK{ for rule in rules }
        \item \VAR{rule}
      \BLOCK{ endfor }
      \end{itemize}
    \end{examrules}
  \end{center}
  \BLOCK{ endif }
\end{coverpages}

\BLOCK{ set has_questions = ("\\question" in mainmatter) or ("\\titledquestion" in mainmatter) or ("\\input" in mainmatter) }
\BLOCK{ if has_questions }
\begin{questions}
\VAR{mainmatter}
\end{questions}
\BLOCK{ else }
\PackageWarning{texsmith}{No questions found; exam.cls may fail to compile.}
\VAR{mainmatter}
\BLOCK{ endif }

\end{document}
